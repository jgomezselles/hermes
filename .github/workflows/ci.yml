name: CI
on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:

jobs:

  formatting-check:
    name: Check code format
    runs-on: ubuntu-latest
    steps:
    - name: Checkout hermes repo
      uses: actions/checkout@v2
    - name: Run clang format
      run: |
          find . -regex '.*\.\(cpp\|hpp\|cc\|cxx\|h\|c\|hh\)' -exec clang-format -style=file -i {} \;
          git diff --exit-code

  compile-and-unit-tests:
    name: Compile and run unit tests
    runs-on: ubuntu-latest
    container:
      image: jgomezselles/hermes_base:0.0.1
      options: "--entrypoint sh"
    steps:
    - uses: actions/checkout@v2
    - run: cmake -B build  -DCMAKE_BUILD_TYPE=Debug .
    - run: make -j -C build
    - run: apk add lcov --update-cache --repository  http://dl-3.alpinelinux.org/alpine/edge/testing/
    - run: lcov -i --capture --directory "${PWD}/build/src/" --output-file base-coverage.info --no-external --directory "${PWD}/" --exclude '*/ut/*'
    - run: ./build/ut/unit-test
    - run: lcov --capture --directory "${PWD}/build/src/" --output-file test-coverage.info --no-external --directory "${PWD}/" --exclude '*/ut/*'
    - run: lcov -a base-coverage.info  -a test-coverage.info  -o total-coverage.info

    - name: Coveralls
      uses: coverallsapp/github-action@master
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        path-to-lcov: total-coverage.info